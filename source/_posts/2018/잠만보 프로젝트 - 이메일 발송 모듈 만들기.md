---
title: 잠만보 프로젝트 - 이메일 발송 모듈 만들기
date: 2018-12-07
categories: [프로젝트, 잠만보]
---

## 개요  
오늘은 회원가입을 하거나 비밀번호를 찾을 때 필요한 이메일 발송 모듈을 만들어보려고 합니다. 기본적으로는 구글이나 네이버 같은 SMTP 서버를 이용할 수 있도록 JavaMailSender를 이용하는 것과 아마존 웹 서비스의 SimpleEmailService를 이용하는 것 두가지를 제공하려고 해요.

#### 이메일 템플릿 엔진  
이메일의 컨텐츠를 만들 때 자바 코드로 만들지 않고 템플릿 엔진을 이용해서 만들 수 있도록 하는 것이 좋을 것 같아요.

> 최근에 회사 내 프로젝트의 이메일 템플릿 모듈을 Velocity 기반에서 Freemarker로 전환하는 시도를 했습니다.

스프링 프레임워크에서 Velocity가 2010년 이후로 업데이트가 안된다고 2017년에 스프링 부트 스타터 지원에서 제외되었습니다. 그런데 이렇게 제외된 후 Velocity 2.0이 2017년에 바로 업데이트되었습니다.

때문에 Velocity, Thymeleaf, Freemarker중에 선택해서 사용하면 될 듯하여 세가지 전부 구현하도록 하겠습니다.

> 여러분은 하나만 선택해서 사용하면 됩니다.

## 의존성  

```groovy
dependencies {
    implementation('org.springframework.boot:spring-boot-starter-mail')
    implementation('com.amazonaws:aws-java-sdk-core:1.11.464')
    implementation('com.amazonaws:aws-java-sdk-ses:1.11.464')
    implementation('org.springframework.boot:spring-boot-starter-thymeleaf')
    implementation('org.springframework.boot:spring-boot-starter-freemarker')
    implementation('org.apache.velocity:velocity-engine-core:2.0')
}
```

> Velocity에 대한 starter 의존성을 제공하지 않기 때문에 개별적으로 가져오도록 합시다.

## 템플릿 엔진 설정  
#### Thymeleaf Template Engine
타임리프 템플릿 엔진은 `Sending email in Spring with Thymeleaf`는 템플릿 리졸버가 많지만 저는 html에 대해서만 적용했습니다.
```java
/**
 * Thymeleaf
 * @return {@link SpringTemplateEngine}
 */
@Bean("thymeleafEmailTemplateEngine")
public TemplateEngine thymeleafEmailTemplateEngine() {
    final SpringTemplateEngine templateEngine = new SpringTemplateEngine();
    templateEngine.addTemplateResolver(htmlTemplateResolver());
    templateEngine.setTemplateEngineMessageSource(emailMessageSource());
    return templateEngine;
}

private ITemplateResolver htmlTemplateResolver() {
    final ClassLoaderTemplateResolver templateResolver = new ClassLoaderTemplateResolver();
    templateResolver.setOrder(1);
    templateResolver.setPrefix("/templates/mail/");
    templateResolver.setSuffix(".html");
    templateResolver.setTemplateMode(TemplateMode.HTML);
    templateResolver.setCharacterEncoding("UTF-8");
    templateResolver.setCacheable(false);
    return templateResolver;
}
```

#### Freemarker Template Engine
```java
/**
 * Freemarker
 * @return {@link freemarker.template.Configuration}
 */
@Bean
public freemarker.template.Configuration freemarkerConfiguration() throws IOException, TemplateException {
    FreeMarkerConfigurationFactoryBean freeMarker = new FreeMarkerConfigurationFactoryBean();
    freeMarker.setTemplateLoaderPath("classpath:/templates/mail");
    return freeMarker.createConfiguration();
}
```

#### Velocity Template Engine  
```java
/**
 * Velocity
 * @return {@link VelocityEngine}
 */
@Bean
public VelocityEngine velocityEngine() {
    final Properties properties = new Properties();
    properties.put(RuntimeConstants.RESOURCE_LOADER, "class");
    properties.put("class.resource.loader.class", ClasspathResourceLoader.class.getName());
    VelocityEngine velocityEngine = new VelocityEngine(properties);
    velocityEngine.init();
    return velocityEngine;
}
```

## 템플릿 빌더 구현  
이메일 템플릿 빌더의 인터페이스는 제네릭 타입을 받아 처리하도록 하였는데 각 템플릿의 컨텍스트인 IContext나 Context 인터페이스의 구현체를 만들어서 처리해도 됩니다.

```java
public interface EmailTemplateBuilder<T> {
    String build(String templateName, T context) throws MessagingException, IOException, TemplateException;
}
```
#### Thymeleaf Template Builder
```java
@Scope(value = "prototype")
@Service
public class ThymeleafEmailTemplateBuilder implements EmailTemplateBuilder<IContext> {

    private final TemplateEngine thymeleafEmailTemplateEngine;

    @Autowired
    public ThymeleafEmailTemplateBuilder(@Qualifier("thymeleafEmailTemplateEngine") TemplateEngine thymeleafEmailTemplateEngine) {
        this.thymeleafEmailTemplateEngine = thymeleafEmailTemplateEngine;
    }

    @Override
    public String build(String templateName, IContext context) throws MessagingException {
        String template = thymeleafEmailTemplateEngine.process(templateName, context);
        return template;
    }
}
```

#### Freemarker Template Builder
```java
@Scope(value = "prototype")
@Service
public class FreemarkerEmailTemplateBuilder implements EmailTemplateBuilder<Map<String, Object>> {
    private final Configuration freemarkerEmailTemplateEngine;

    @Autowired
    public FreemarkerEmailTemplateBuilder(@Qualifier("freemarkerConfiguration") Configuration freemarkerEmailTemplateEngine) {
        this.freemarkerEmailTemplateEngine = freemarkerEmailTemplateEngine;
    }

    @Override
    public String build(String templateName, Map<String, Object> variables) throws IOException, TemplateException, MessagingException {
        String template = FreeMarkerTemplateUtils.processTemplateIntoString(freemarkerEmailTemplateEngine.getTemplate(templateName), variables);
        return template;
    }
}
```

#### Velocity Template Builder
벨로시티 템플릿 빌더는 템플릿 이름을 파라미터를 받아 `/templates/mail/`라는 Prefix를 붙였습니다. 그 이유는 템플릿 엔진을 만들때 클래스패스로더를 사용하였기 때문이에요
```java
@Scope(value = "prototype")
@Service
public class VelocityEmailTemplateBuilder implements EmailTemplateBuilder<Context> {
    private final VelocityEngine velocityEngine;

    @Autowired
    public VelocityEmailTemplateBuilder(VelocityEngine velocityEngine) {
        this.velocityEngine = velocityEngine;
    }

    @Override
    public String build(String templateName, Context context) {
        StringWriter writer = new StringWriter();
        velocityEngine.mergeTemplate("/templates/mail/" + templateName, "UTF-8", context, writer);
        String template = writer.toString();
        return template;
    }
}
```

## 이메일 서비스 구현  
각 템플릿 빌더를 만들었으니 이메일을 발송하는 서비스 클래스를 만들어야 합니다. 이메일 서비스 클래스에서는 MimeMessageHelper를 만드는 빌드 함수와 JavaMailSender와 AmazonSimpleEmailService로 이메일을 보내는 함수를 구현합니다.

```java
@Service
public class MailService {

    @Getter
    private final FreemarkerEmailTemplateBuilder freemarkerEmailTemplateBuilder;
    @Getter
    private final ThymeleafEmailTemplateBuilder thymeleafEmailTemplateBuilder;
    @Getter
    private final VelocityEmailTemplateBuilder velocityEmailTemplateBuilder;
    private final JavaMailSender javaMailSender;
    private final AmazonSimpleEmailService amazonSimpleEmailService;

    @Autowired
    public MailService(JavaMailSender javaMailSender,
                       AmazonSimpleEmailService amazonSimpleEmailService,
                       FreemarkerEmailTemplateBuilder freemarkerEmailTemplateBuilder,
                       ThymeleafEmailTemplateBuilder thymeleafEmailTemplateBuilder,
                       VelocityEmailTemplateBuilder velocityEmailTemplateBuilder) {
        this.javaMailSender = javaMailSender;
        this.amazonSimpleEmailService = amazonSimpleEmailService;
        this.freemarkerEmailTemplateBuilder = freemarkerEmailTemplateBuilder;
        this.thymeleafEmailTemplateBuilder = thymeleafEmailTemplateBuilder;
        this.velocityEmailTemplateBuilder = velocityEmailTemplateBuilder;
    }
}
```

#### build()
빌드 함수는 `javax.mail.Session` 인스턴스를 통해 `MimeMessage`를 생성하고 `MimeMessageHelper` 클래스를 반환합니다.

```java
@Service
public class MailService {

    // ...

    public MimeMessageHelper build(String subject, String from, String[] to, int multipartMode) throws MessagingException {
        final Properties properties = new Properties();
        Session session = Session.getInstance(properties);

        final MimeMessage mimeMessage = new MimeMessage(session);
        MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage, multipartMode, "UTF-8");
        mimeMessageHelper.setTo(to);
        mimeMessageHelper.setFrom(from);
        mimeMessageHelper.setSubject(subject);

        return mimeMessageHelper;
    }
}
```

#### sendUsingXXXX()
발송 함수는 빌드 함수에 의해 반환된 `MimeMessageHelper`에서 MimeMessage를 가져오고 발송 담당 클래스에 따라 이메일 발송을 처리합니다.

```java
@Service
public class MailService {

    // ...

    public void sendUsingJavaMailSender(MimeMessageHelper mimeMessageHelper) {
        final MimeMessage mimeMessage = mimeMessageHelper.getMimeMessage();
        this.javaMailSender.send(mimeMessage);
    }

    public void sendUsingAmazonSESService(MimeMessageHelper mimeMessageHelper) throws IOException, MessagingException {
        final MimeMessage mimeMessage = mimeMessageHelper.getMimeMessage();

        ByteArrayOutputStream os = new ByteArrayOutputStream();
        mimeMessage.writeTo(os);
        RawMessage rawMessage = new RawMessage(ByteBuffer.wrap(os.toByteArray()));

        SendRawEmailRequest rawEmailRequest = new SendRawEmailRequest(rawMessage);
        amazonSimpleEmailService.sendRawEmail(rawEmailRequest);
    }
}
```

#### 이메일 내용은 언제 어디서 넣는거죠  
이메일 서비스를 의존하는 다른 서비스 클래스에서 `build()`와 `sendUsingXXXX()`를 호출하는 사이에 내용이나 첨부파일을 설정해야합니다.

아래의 테스트 케이스처럼 말이에요
```java
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public class MailServiceTest extends SpringBootSnorlaxApplicationTests {

    @Autowired
    MailService mailService;

    private MimeMessageHelper helper;

    @Before
    public void init() throws MessagingException, IOException, TemplateException {
        helper = mailService.build("Send Email Test", "kdevkr@gmail.com", new String[]{"kdevkr@gmail.com"}, MimeMessageHelper.MULTIPART_MODE_NO);
        final Map<String, Object> variables = Maps.newHashMap();
        helper.setText(mailService.getFreemarkerEmailTemplateBuilder().build("default.html", variables), true);
    }

    @Test
    public void TEST001_sendMailByJavaMailSender() {
        mailService.sendUsingJavaMailSender(helper);
    }

    @Test
    public void TEST002_sendMailByAmazonSimpleEmailService() throws IOException, MessagingException {
        mailService.sendUsingAmazonSESService(helper);
    }
}
```

## 이메일 발송 처리자 구현
이메일 발송은 javaMailSender와 AmazonSimpleEmailService를 지원하도록 합시다

```java
@Configuration
public class MailConfiguration implements ApplicationContextAware, EnvironmentAware {

    private static final Logger LOG = LoggerFactory.getLogger(MailConfiguration.class);
    private ApplicationContext applicationContext;
    private Environment environment;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }

    @Bean
    public JavaMailSender javaMailSender() throws IOException {
        final JavaMailSenderImpl mailSender = new JavaMailSenderImpl();

        mailSender.setHost(environment.getProperty("spring.mail.host"));
        mailSender.setPort(Integer.valueOf(environment.getProperty("spring.mail.port")));
        mailSender.setProtocol(environment.getProperty("spring.mail.protocol"));
        mailSender.setUsername(environment.getProperty("spring.mail.username"));
        mailSender.setPassword(environment.getProperty("spring.mail.password"));
        final Properties javaMailProperties = new Properties();
        javaMailProperties.load(applicationContext.getResource("classpath:mail.properties").getInputStream());
        mailSender.setJavaMailProperties(javaMailProperties);
        return mailSender;
    }

    @Bean
    public AmazonSimpleEmailService amazonSimpleEmailService() {
        AmazonSimpleEmailService amazonSimpleEmailService = AmazonSimpleEmailServiceClientBuilder
                .standard()
                .withCredentials(awsCredentialsProvider)
                .withRegion(Regions.US_EAST_1)
                .build();
        return amazonSimpleEmailService;
    }
}
```

#### JavaMailSender  
저는 JavaMailSender가 구글 SMTP 서버를 이용하도록 프로퍼티 설정을 하였습니다.

```properties
# application.properties
spring.mail.host=smtp.gmail.com
spring.mail.username=kdevkr@gmail.com
spring.mail.password=
spring.mail.port=465
spring.mail.test-connection=true

# mail.properties
mail.smtp.ssl.enable=true
mail.smtp.auth=true
```

```java
@Configuration
public class MailConfiguration implements ApplicationContextAware, EnvironmentAware {

    // ...

    @Bean
    public JavaMailSender javaMailSender() throws IOException {
        final JavaMailSenderImpl mailSender = new JavaMailSenderImpl();

        mailSender.setHost(environment.getProperty("spring.mail.host"));
        mailSender.setPort(Integer.valueOf(environment.getProperty("spring.mail.port")));
        mailSender.setProtocol(environment.getProperty("spring.mail.protocol"));
        mailSender.setUsername(environment.getProperty("spring.mail.username"));
        mailSender.setPassword(environment.getProperty("spring.mail.password"));
        final Properties javaMailProperties = new Properties();
        javaMailProperties.load(applicationContext.getResource("classpath:mail.properties").getInputStream());
        mailSender.setJavaMailProperties(javaMailProperties);
        return mailSender;
    }
}
```

#### AmazonSimpleEmailService  
아마존 웹 서비스를 이용하기 위해서는 [AWS 자격 증명 작업](https://docs.aws.amazon.com/ko_kr/sdk-for-java/v1/developer-guide/credentials.html)을 제공해야 합니다. 배포 환경에서는 기본 자격 증명 체인을 이용하고 로컬 개발 환경인 경우에는 자격 증명을 명시적으로 제공하기 위해서 `AWSStaticCredentialsProvider` 클래스를 이용하도록 했습니다.

> 로컬 개발환경에서 기본 자격 증명 체인을 이용하고 싶다면 AWS 자격 증명 프로필 파일를 로컬 시스템에 등록하거나 환경 변수를 설정해야겠죠

```java
@Configuration
public class MailConfiguration implements ApplicationContextAware, EnvironmentAware {

    // ...
    private AWSCredentialsProvider awsCredentialsProvider;

    @Override
    public void setEnvironment(Environment environment) {
        this.environment = environment;
        if(ArrayUtils.contains(environment.getActiveProfiles(), "production")) {
            // 배포 환경일 경우 AWS의 기본 자격 증명 공급자 체인을 사용
            awsCredentialsProvider = DefaultAWSCredentialsProviderChain.getInstance();
        } else {
            // 배포 환경이 아닐 경우 AWS 액세스 자격 증명을 명시적으로 지정하여 사용
            LOG.warn("[주의] AWS 액세스 자격 증명 정보를 프로퍼티 대신 VM 환경변수로 지정하세요");
            final String accessKeyId = environment.getProperty("aws.credential.access-key-id");
            final String secretKeyId = environment.getProperty("aws.credential.secret-key-id");
            awsCredentialsProvider = new AWSStaticCredentialsProvider(new BasicAWSCredentials(accessKeyId, secretKeyId));
        }
    }

    @Bean
    public AmazonSimpleEmailService amazonSimpleEmailService() {
        AmazonSimpleEmailService amazonSimpleEmailService = AmazonSimpleEmailServiceClientBuilder
                .standard()
                .withCredentials(awsCredentialsProvider)
                .withRegion(Regions.US_EAST_1)
                .build();
        return amazonSimpleEmailService;
    }
}
```

##### ses:SendRawEmail
AWS 계정에 따라 ses:SendRawEmail에 대한 권한을 가져야 이메일을 발송할 수 있으니 참고하시기 바랍니다.

## 이슈  
#### 이메일 템플릿의 인라인 CSS
구글의 Gmail은 [CSS 스타일 태그를 지원](https://developers.google.com/gmail/design/css)합니다. 하지만, 다른 이메일 클라이언트는 스타일 태그를 무시할 수도 있어요. 따라서, 모든 클라이언트를 대비한다면 스타일 태그에 있는 것을 인라인 CSS 스타일 형식으로 변환해주는 라이브러리 또는 사이트를 이용하는 것이 하나의 방법일 수 있습니다.

- https://premailer.io  
- https://github.com/Automattic/juice


## 참고  
- [Sending email in Spring with Thymeleaf](https://www.thymeleaf.org/doc/articles/springmail.html)  
- [Amazon SES API를 사용하여 원시 이메일 보내기](https://docs.aws.amazon.com/ko_kr/ses/latest/DeveloperGuide/send-email-raw.html)  
- [How To Use Google's SMTP Server](https://www.digitalocean.com/community/tutorials/how-to-use-google-s-smtp-server)
- [AWS 자격 증명 작업](https://docs.aws.amazon.com/ko_kr/sdk-for-java/v1/developer-guide/credentials.html)
