---
title: 스프링 시큐리티 이해하기
date: 2099-12-21
categories: [이해하기, Spring]
---

::: tip 샘플 애플리케이션
스프링 시큐리티는 자바 설정의 많은 [샘플 애플리케이션](https://github.com/spring-projects/spring-security/tree/master/samples/javaconfig)을 제공한다.
:::

## 29.시큐리티

> https://docs.spring.io/spring-boot/docs/2.0.x/reference/htmlsingle/#boot-features-security

```groovy
dependencies {
    compile "org.springframework.boot:spring-boot-starter-security"
}
```

클래스 패스에 스프링 시큐리티가 있으면 웹 애플리케이션은 기본적인 보안이 적용된다. 스프링 부트가 `httpBasic` 또는 `formLogin`을 사용할 지는 스프링 시큐리티의 컨텐츠 협상 전략에 따라 결정된다. 웹 애플리케이션의 메소드 레벨의 보안을 추가하기를 원한다면 `@EnableGlobalMethodSecurity`을 추가할 수 있다. 추가적인 정보는 [스프링 시큐리티 레퍼런스 가이드](https://docs.spring.io/spring-security/site/docs/5.0.x/reference/htmlsingle/#jc-method)에서 확인할 수 있다.

기본 `UserDetailsService`는 단일 사용자를 가진다.

### 29.1 MVC 시큐리티
기본적인 보안 설정은 `SecurityAutoConfiguration`과 `UserDetailsServiceAutoConfiguration`에서 구현된다. `SecurityAutoConfiguration`가
웹 보안을 위한 `SpringBootWebSecurityConfiguration`을 포함하며 `UserDetailsServiceAutoConfiguration`은 인증을 구성한다. 기본 웹 애플리케이션 보안 설정을 완벽하게 대체하기 위해서는 `WebSecurityConfigurerAdapter` 타입의 빈을 등록하면 된다.

또 `UserDetailsService` 설정을 대체하려면 `UserDetailsService`, `AuthenticationProvider` 또는 `AuthenticationManager` 타입의 빈을 추가하면 된다.  

액세스 규칙은 커스텀 `WebSecurityConfigurerAdapter`를 추가해서 재정의할 수 있다. 스프링 부트는 정적 리소스와 액츄에이터 앤드포인트를 위한 액세스 규칙을 재정의하는데 사용하는 편리한 메소드를 제공한다. `EndpointRequest`를 사용해서 `management.endpoints.web.base-path` 속성을 기반으로 `RequestMatcher`를 만들 수 있다. `PathRequest`를 사용해서 리소스를 위한 `RequestMatcher`를 만들 수 있다.

### 29.2 WebFlux 시큐리티
스프링 MVC 애플리케이션과 비슷하게 `spring-boot-starter-security` 의존성을 추가함으로써 WebFlux 애플리케이션에 보안을 적용할 수 있다. 기본 보안 설정은 `ReactiveSecurityAutoConfiguration` 과 `UserDetailsServiceAutoConfiguration`에서 구현된다. `ReactiveSecurityAutoConfiguration`가 웹 보안을 위한 `WebFluxSecurityConfiguration`을 포함하며 `UserDetailsServiceAutoConfiguration`은 인증을 구성한다. 기본 웹 애플리케이션 보안 설정을 완벽하게 대체하기 위해서는 `WebFilterChainProxy` 타입의 빈을 등록하면 된다.

또 `UserDetailsService` 설정을 대체하려면 `ReactiveUserDetailsService` 또는 `ReactiveAuthenticationManager` 타입의 빈을 추가하면 된다.

액세스 규칙은 커스텀 `SecurityWebFilterChain`을 추가해서 설정할 수 있다. 스프링 부트는 정적 리소스와 액츄에이터 앤드포인트를 위한 액세스 규칙을 재정의하는데 사용하는 편리한 메소드를 제공한다.
`EndpointRequest`를 사용해서 `management.endpoints.web.base-path` 속성을 기반으로 `ServerWebExchangeMather`를 만들 수 있다. `PathRequest`를 사용해서 리소스를 위한 `ServerWebExchangeMatcher `를 만들 수 있다.

예를 들어, 다음을 추가해서 보안 설정을 커스터마이즈할 수 있다.
```java
@Bean
public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
	return http
		.authorizeExchange()
			.matchers(PathRequest.toStaticResources().atCommonLocations()).permitAll()
			.pathMatchers("/foo", "/bar")
				.authenticated().and()
			.formLogin().and()
		.build();
}
```

### 29.3 OAuth2
OAuth2는 널리 사용하는 인증 프레임워크이며 스프링은 이를 지원한다.

#### 29.3.1 클라이언트
`spring-security-oauth2-client`가 클래스패스에 있으면 몇가지의 자동 설정에 따라 OAuth2 클라이언트 설정을 할 수 있다. 이 설정은 `OAuth2ClientProperties` 아래의 속성을 사용한다.

다음의 예제처럼 `spring.security.oauth2.client` 접두사 아래에 복수의 Oauth2 클라이언트와 공급자를 등록할 수 있다.
```properties
spring.security.oauth2.client.registration.my-client-1.client-id=abcd
spring.security.oauth2.client.registration.my-client-1.client-secret=password
spring.security.oauth2.client.registration.my-client-1.client-name=Client for user scope
spring.security.oauth2.client.registration.my-client-1.provider=my-oauth-provider
spring.security.oauth2.client.registration.my-client-1.scope=user
spring.security.oauth2.client.registration.my-client-1.redirect-uri-template=http://my-redirect-uri.com
spring.security.oauth2.client.registration.my-client-1.client-authentication-method=basic
spring.security.oauth2.client.registration.my-client-1.authorization-grant-type=authorization_code

spring.security.oauth2.client.registration.my-client-2.client-id=abcd
spring.security.oauth2.client.registration.my-client-2.client-secret=password
spring.security.oauth2.client.registration.my-client-2.client-name=Client for email scope
spring.security.oauth2.client.registration.my-client-2.provider=my-oauth-provider
spring.security.oauth2.client.registration.my-client-2.scope=email
spring.security.oauth2.client.registration.my-client-2.redirect-uri-template=http://my-redirect-uri.com
spring.security.oauth2.client.registration.my-client-2.client-authentication-method=basic
spring.security.oauth2.client.registration.my-client-2.authorization-grant-type=authorization_code

spring.security.oauth2.client.provider.my-oauth-provider.authorization-uri=http://my-auth-server/oauth/authorize
spring.security.oauth2.client.provider.my-oauth-provider.token-uri=http://my-auth-server/oauth/token
spring.security.oauth2.client.provider.my-oauth-provider.user-info-uri=http://my-auth-server/userinfo
spring.security.oauth2.client.provider.my-oauth-provider.jwk-set-uri=http://my-auth-server/token_keys
spring.security.oauth2.client.provider.my-oauth-provider.user-name-attribute=name
```

기본적으로 스프링 시큐리티의 `OAuth2LoginAuthenticationFilter`는 오직 `/login/oauth2/code/*` URL 매칭을 처리한다. 만약 다른 패턴을 사용하기 위해서는 `redirect-uri-template`를 커스터마이즈 하길 원한다면 커스텀 패턴을 처리하도록 설정을 제공할 필요가 있다. 예를 들어, `WebSecurityConfigurerAdapter`에 다음과 같이 추가할 수 있다.
```java
public class OAuth2LoginSecurityConfig extends WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			.authorizeRequests()
				.anyRequest().authenticated()
				.and()
			.oauth2Login()
				.redirectionEndpoint()
					.baseUri("/custom-callback");
	}
}
```

Google, Github, Facebook 및 Okta를 비롯한 일반적인 OAuth2 및 OpenID 제공 업체를 위해 Google에서는 제공자 기본값을 제공한다.

#### 29.3.2 서버
현재 스프링 시큐리티는 OAuth 2.0 인증 서버 또는 리소스 서버 구현을 위한 지원을 제공하지 않는다. 그러나, 이 기능은 스프링 시큐리티 OAuth 프로젝트에서 이용 가능하고 이 프로젝트는 결국 스프링 시큐리티로 완전히 대체 될 것이다. 그때까지는 `spring-security-oauth2-autoconfigure` 모듈을 사용해서 OAuth 2.0 서버를 쉽게 설정할 수 있다.



## 참고
- [Spring Security Reference](https://docs.spring.io/spring-security/site/docs/current/reference/html5/)
- [Spring Security’s source code](https://github.com/spring-projects/spring-security/)
